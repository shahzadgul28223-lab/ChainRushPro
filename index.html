<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChainRush Pro - Official Launch</title>
    <meta property="og:title" content="ChainRush Pro">
    <meta property="og:image" content="https://i.ibb.co/LzNfXFk/Chain-Rush-Logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #00c6ff; --gold: #f39c12; --dark: #0a0a0a; --glass: rgba(255, 255, 255, 0.1); }
        body { background-color: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; text-align: center; }
        
        /* 3. Notification Styling Adjusted (Small, Left side, Slide in from left) */
        #notification-container { position: fixed; top: 15px; left: 15px; z-index: 10000; width: 220px; pointer-events: none; }
        .noti-card { 
            padding: 8px; border-radius: 12px; margin-bottom: 8px; 
            display: flex; align-items: center; animation: slideInLeft 0.5s ease forwards; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);
            color: white; font-weight: 500;
        }
        .noti-img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; border: 1px solid #fff; object-fit: cover; }
        
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }

        .header { background: linear-gradient(135deg, #1e3c72, #2a5298, #f39c12); padding: 40px 20px; border-bottom: 4px solid var(--gold); border-radius: 0 0 30px 30px; }
        .wallet-btn { background: #00c6ff; border: none; padding: 12px 25px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,198,255,0.4); }
        .user-id { font-size: 28px; font-weight: bold; color: var(--gold); }
        .profile-img { width: 110px; height: 110px; border-radius: 50%; border: 4px solid var(--gold); margin: 15px auto; display: block; }

        .admin-panel { background: #151515; border: 2px solid #e74c3c; margin: 20px; padding: 20px; border-radius: 20px; display: none; }
        .team-list { background: #111; border: 1px solid #333; margin: 10px 0; padding: 10px; max-height: 150px; overflow-y: auto; text-align: left; font-size: 12px; border-radius: 10px; }
        input, select { width: 85%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #000; color: white; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 20px; }
        .stat-card { background: #1e1e1e; padding: 15px; border-radius: 15px; border-left: 4px solid var(--primary); }
        .stat-val { font-size: 18px; font-weight: bold; color: var(--gold); }

        .report-box { background: #111; margin: 0 20px; border-radius: 15px; border: 1px solid var(--primary); padding: 15px; text-align: left; }
        .report-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #333; }

        .level-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .level-card { background: #1a1a1a; padding: 20px; border-radius: 25px; border: 2px solid #333; position: relative; }
        .active-lvl { border-color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .buy-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; color: white; }

        .footer { padding: 30px; background: #111; border-top: 2px solid var(--gold); margin-top: 40px; text-align: left; font-size: 13px; line-height: 1.6; color: #ccc; }
    </style>
</head>
<body>

    <div id="notification-container"></div>

    <div class="header">
        <button class="wallet-btn" onclick="connectWallet()" id="wallBtn">Connect Wallet</button>
        <div id="usdtBal" style="margin-top:10px; color:#2ecc71; font-weight:bold;">USDT: $0.00</div>
        <div class="user-id">ID: <span id="displayId">...</span></div>
        <img src="https://i.pravatar.cc/150" class="profile-img" id="userAvatar">
    </div>

    <div id="adminPanel" class="admin-panel">
        <h3 style="color:#e74c3c;">OWNER CONTROL PANEL</h3>
        <div class="team-list" id="fullTeamIds">Loading Team IDs...</div>
        <input type="text" id="giftTarget" placeholder="Target User ID">
        <select id="giftLevel">
            <script>for(let i=1;i<=12;i++) document.write(`<option value="${i}">Activate Level ${i}</option>`);</script>
        </select>
        <button class="buy-btn" style="background:#e74c3c;" onclick="processGift()">GIFT NOW (FREE)</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div>Active Level</div><div class="stat-val" id="userLvl">0</div></div>
        <div class="stat-card"><div>Team Income</div><div class="stat-val" id="teamInc">$0.00</div></div>
        <div class="stat-card"><div>Total Income</div><div class="stat-val" id="totInc">$0.00</div></div>
        <div class="stat-card"><div>Total Team</div><div class="stat-val" id="totTeam">0</div></div>
    </div>

    <div class="report-box">
        <b style="color:var(--primary)">NETWORK REPORT</b>
        <div class="report-row"><span>Direct Members</span> <span id="dirTeam">0</span></div>
        <div class="report-row"><span>Total Network</span> <span id="repTot">0</span></div>
    </div>

    <div class="copy-section" style="padding:20px;">
        <div id="refUrl" style="font-size: 11px; word-break: break-all; color:#888;">Connect Wallet to get link</div>
        <button class="copy-btn" onclick="copyRef()" style="background:var(--gold); border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold; margin-top:10px;">COPY REFERRAL LINK</button>
    </div>

    <div class="level-grid" id="levelsContainer"></div>

    <div class="footer">
        <h3 style="color:var(--gold); text-align:center;">ChainRush-Pro (Decentralized)</h3>
        <p style="text-align:center; font-size:10px; color:#555;">Â© 2026 ChainRush Pro Germany. Secure Blockchain System.</p>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxzfp_f2Y0tStBsYNLx9xjWb6EgXFnXqg",
        authDomain: "chainrushpro.firebaseapp.com",
        databaseURL: "https://chainrushpro-default-rtdb.firebaseio.com",
        projectId: "chainrushpro",
        storageBucket: "chainrushpro.firebasestorage.app",
        messagingSenderId: "475042665109",
        appId: "1:475042665109:web:c1b6f59d3bde82b449c19c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ownerWallet = "0x40642a42Eb9EDbf936C5DA1AE71E5d762A3B0f46";
    const usdtAddress = "0x55d398326f99059fF775485246999027B3197955";
    const usdtAbi = ["function balanceOf(address) view returns (uint256)", "function transfer(address, uint256) returns (bool)"];
    
    let currentUserData = null;
    const urlParams = new URLSearchParams(window.location.search);
    const inviterId = urlParams.get('ref') || "4970";

    // NOTIFICATION LOGIC
    const colors = ['linear-gradient(90deg, #FF512F 0%, #DD2476 100%)', 'linear-gradient(90deg, #1D976C 0%, #93F9B9 100%)', 'linear-gradient(90deg, #00c6ff 0%, #0072ff 100%)', 'linear-gradient(90deg, #f39c12 0%, #e67e22 100%)', 'linear-gradient(90deg, #8E2DE2 0%, #4A00E0 100%)'];
    function triggerLiveNotification() {
        const id = Math.floor(10000 + Math.random() * 90000);
        const lvl = Math.floor(1 + Math.random() * 12);
        const color = colors[Math.floor(Math.random() * colors.length)];
        const types = ["Joined System", "Upgraded Level", "Received Income", "New Member"];
        const type = types[Math.floor(Math.random() * types.length)];
        const container = document.getElementById('notification-container');
        const card = document.createElement('div');
        card.className = 'noti-card';
        card.style.background = color;
        /* Adjusted notification inner HTML for smaller size */
        card.innerHTML = `<img src="https://i.pravatar.cc/100?u=${id}" class="noti-img"><div style="text-align:left;"><div style="font-size:10px; opacity:0.8;">ID: ${id}</div><div style="font-size:12px; font-weight:bold;">${type} ${lvl > 0 ? 'Lvl '+lvl : ''}</div><div style="font-size:9px; color:#fff;">Just Now</div></div>`;
        container.appendChild(card);
        setTimeout(() => { card.style.animation = "fadeOut 0.5s ease forwards"; setTimeout(() => card.remove(), 500); }, 3500);
    }
    setInterval(triggerLiveNotification, 4000);

    window.connectWallet = async () => {
        if (!window.ethereum) return alert("Install MetaMask!");
        const accs = await window.ethereum.request({method:'eth_requestAccounts'});
        const wallet = accs[0];
        document.getElementById('wallBtn').innerText = wallet.substring(0,6)+"...";
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const contract = new ethers.Contract(usdtAddress, usdtAbi, provider);
        const bal = await contract.balanceOf(wallet);
        document.getElementById('usdtBal').innerText = "USDT: $" + parseFloat(ethers.utils.formatUnits(bal, 18)).toFixed(2);
        if (wallet.toLowerCase() === ownerWallet.toLowerCase()) { document.getElementById('adminPanel').style.display = 'block'; loadFullTeam(); }
        loadUser(wallet);
    };

    async function updateTeamCounts(sponsorId) {
        let currentSponsor = sponsorId;
        let isFirst = true;
        while(currentSponsor) {
            const idSnap = await get(ref(db, 'users_by_id/' + currentSponsor));
            if(!idSnap.exists()) break;
            const sWallet = idSnap.val().wallet;
            const sRef = ref(db, 'users_by_wallet/' + sWallet);
            
            const updates = { network: increment(1) };
            if(isFirst) { updates.directs = increment(1); isFirst = false; }
            
            await update(sRef, updates);
            const sData = (await get(sRef)).val();
            currentSponsor = sData.inviter;
        }
    }

    async function loadUser(wallet) {
        const userRef = ref(db, 'users_by_wallet/' + wallet);
        const snap = await get(userRef);
        let data = snap.val();
        if (!data) {
            const newId = Math.floor(10000 + Math.random() * 80000).toString();
            data = { id: newId, level: 0, tIncome: 0, directs: 0, network: 0, inviter: inviterId, wallet: wallet };
            await set(userRef, data);
            await set(ref(db, 'users_by_id/' + newId), { wallet: wallet, inviter: inviterId });
            await updateTeamCounts(inviterId);
        }
        currentUserData = data;
        updateUI(data);
        renderLevels(data.level);
    }

    function updateUI(data) {
        onValue(ref(db, 'users_by_wallet/' + data.wallet), (snapshot) => {
            const updatedData = snapshot.val();
            document.getElementById('displayId').innerText = updatedData.id;
            document.getElementById('userLvl').innerText = updatedData.level;
            document.getElementById('totTeam').innerText = updatedData.network;
            document.getElementById('dirTeam').innerText = updatedData.directs;
            document.getElementById('repTot').innerText = updatedData.network;
            document.getElementById('refUrl').innerText = `https://chain-rush-pro.vercel.app/?ref=${updatedData.id}`;
        });
    }

    function renderLevels(current) {
        const cont = document.getElementById('levelsContainer');
        cont.innerHTML = "";
        for (let i = 1; i <= 12; i++) {
            let price = 30 * Math.pow(2, i - 1);
            let active = i <= current;
            cont.innerHTML += `<div class="level-card ${active ? 'active-lvl' : ''}"><h3>LEVEL ${i}</h3><p>$${price}</p><button class="buy-btn" style="background:${active ? '#2ecc71' : '#00c6ff'}" onclick="handlePurchase(${i}, ${price})">${active ? 'ACTIVE (LIFE-TIME)' : 'UPGRADE NOW'}</button></div>`;
        }
    }

    async function findQualifiedUpliner(startInviterId, lvl) {
        let currentInviter = startInviterId;
        while(currentInviter) {
            const snap = await get(ref(db, 'users_by_id/' + currentInviter));
            if(!snap.exists()) break;
            const userWall = snap.val().wallet;
            const userSnap = await get(ref(db, 'users_by_wallet/' + userWall));
            const userData = userSnap.val();
            if(userData && userData.level >= lvl) return userData.wallet;
            currentInviter = userData.inviter;
        }
        return ownerWallet;
    }

    window.handlePurchase = async (lvl, price) => {
        if (!currentUserData) return alert("Connect Wallet!");
        if (lvl <= currentUserData.level) return alert("Level already active!");
        if (lvl !== currentUserData.level + 1 && currentUserData.wallet.toLowerCase() !== ownerWallet.toLowerCase()) return alert("Please upgrade levels step-by-step!");
        if (currentUserData.wallet.toLowerCase() === ownerWallet.toLowerCase()) { await update(ref(db, 'users_by_wallet/' + currentUserData.wallet), { level: lvl }); location.reload(); return; }
        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(usdtAddress, usdtAbi, signer);
            const feeAmt = price * 0.10; const directAmt = price * 0.50; const levelAmt = price * 0.10;
            
            /* 2. Custom Alert Message in English */
            alert("Processing Payment Distribution 100% to team...");
            
            await (await contract.transfer(ownerWallet, ethers.utils.parseUnits(feeAmt.toFixed(2), 18))).wait();
            const directWallet = await findQualifiedUpliner(currentUserData.inviter, lvl);
            await (await contract.transfer(directWallet, ethers.utils.parseUnits(directAmt.toFixed(2), 18))).wait();
            let nextInviter = (await get(ref(db, 'users_by_id/' + currentUserData.inviter))).val()?.inviter;
            for(let i=0; i<4; i++) {
                const upWallet = await findQualifiedUpliner(nextInviter, lvl);
                await (await contract.transfer(upWallet, ethers.utils.parseUnits(levelAmt.toFixed(2), 18))).wait();
                const nextSnap = await get(ref(db, 'users_by_wallet/' + upWallet));
                nextInviter = nextSnap.val()?.inviter;
            }
            await update(ref(db, 'users_by_wallet/' + currentUserData.wallet), { level: lvl });
            alert("Upgrade Successful! Lifetime Active.");
            location.reload();
        } catch (e) { 
            /* 1. Custom English message for Insufficient Balance/Fee */
            alert("To purchase a plan on the ChainRush-Pro decentralized system, please add UsdtBep20 and BNB for fees to your wallet first, then upgrade the plan."); 
        }
    };

    window.processGift = async () => {
        const tid = document.getElementById('giftTarget').value;
        const tlvl = parseInt(document.getElementById('giftLevel').value);
        const idSnap = await get(ref(db, 'users_by_id/' + tid));
        if (idSnap.exists()) {
            const userWall = idSnap.val().wallet;
            const userSnap = await get(ref(db, 'users_by_wallet/' + userWall));
            if(tlvl !== userSnap.val().level + 1) return alert("Gift levels step-by-step!");
            await update(ref(db, 'users_by_wallet/' + userWall), { level: tlvl });
            alert("Gifted Successfully!");
        } else { alert("User ID not found!"); }
    };

    async function loadFullTeam() {
        const snap = await get(ref(db, 'users_by_wallet'));
        const listDiv = document.getElementById('fullTeamIds');
        listDiv.innerHTML = "";
        Object.values(snap.val()).forEach(u => { listDiv.innerHTML += `ID: ${u.id} | Lvl: ${u.level} | Wallet: ${u.wallet.substring(0,6)}...<br>`; });
    }

    window.copyRef = () => { const link = document.getElementById('refUrl').innerText; navigator.clipboard.writeText(link); alert("Copied!"); };
</script>
</body>
</html>
